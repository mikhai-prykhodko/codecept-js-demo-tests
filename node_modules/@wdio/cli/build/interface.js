"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _chalk = _interopRequireDefault(require("chalk"));

var _cliSpinners = _interopRequireDefault(require("cli-spinners"));

var _events = _interopRequireDefault(require("events"));

var _interface = _interopRequireDefault(require("@wdio/interface"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-cli');
const clockSpinner = _cliSpinners.default['clock'];
const MAX_RUNNING_JOBS_DISPLAY_COUNT = 10;

class WDIOCLInterface extends _events.default {
  constructor(config, specs, totalWorkerCnt) {
    super();
    this.hasAnsiSupport = !!_chalk.default.supportsColor.hasBasic;
    this.specs = specs;
    this.config = config;
    this.totalWorkerCnt = totalWorkerCnt;
    this.sigintTriggered = false;
    this.interface = new _interface.default();
    this.on('job:start', this.addJob.bind(this));
    this.on('job:end', this.clearJob.bind(this));
    this.setup();
  }

  setup() {
    this.clockTimer = 0;
    this.jobs = new Map();
    this.start = Date.now();
    this.result = {
      finished: 0,
      passed: 0,
      failed: 0
    };
    this.messages = {
      /**
       * messages from worker reporters
       */
      reporter: {},

      /**
       * messages from worker itself
       */
      worker: {}
    };
    this.interface.clearBuffer();
  }
  /**
   * add job to interface
   */


  addJob({
    cid,
    caps,
    specs
  }) {
    this.jobs.set(cid, {
      caps,
      specs
    });
    this.updateView();
  }
  /**
   * clear job from interface
   */


  clearJob({
    cid,
    passed
  }) {
    this.jobs.delete(cid);
    this.result.finished++;

    if (passed) {
      this.result.passed++;
    } else {
      this.result.failed++;
    }

    this.updateView(true);
  }
  /**
   * event handler that is triggered when runner sends up events
   */


  onMessage(event) {
    if (event.origin === 'debugger' && event.name === 'start') {
      clearTimeout(this.interval);
      this.interface.clearAll();
      this.interface.inDebugMode = true;
      this.interface.log(_chalk.default.yellow(event.params.introMessage));
    }

    if (event.origin === 'debugger' && event.name === 'stop') {
      this.interface.inDebugMode = false;
      this.sigintTriggered = false;
      return this.updateView();
    }

    if (!event.origin || !this.messages[event.origin]) {
      return log.warn(`Can't identify message from worker: ${JSON.stringify(event)}, ignoring!`);
    }

    if (!this.messages[event.origin][event.name]) {
      this.messages[event.origin][event.name] = [];
    }

    this.messages[event.origin][event.name].push(event.content);
  }

  sigintTrigger() {
    /**
     * allow to exit repl mode via Ctrl+C
     */
    if (this.interface.inDebugMode) {
      return;
    }

    this.sigintTriggered = true;
    this.updateView();
  }

  updateView(wasJobCleared) {
    const totalJobs = this.totalWorkerCnt;
    const pendingJobs = this.totalWorkerCnt - this.jobs.size - this.result.finished;
    const runningJobs = this.jobs.size;
    const isFinished = runningJobs === 0;
    /**
     * check if environment supports ansi and print a limited update if not
     */

    if (!this.hasAnsiSupport && !isFinished) {
      /**
       * only update if a job finishes
       */
      if (!wasJobCleared) {
        return;
      }

      const clockSpinnerSymbol = this.getClockSymbol();
      return this.interface.log(`${clockSpinnerSymbol} ` + `${this.jobs.size} running, ` + `${this.result.passed} passed, ` + `${this.result.failed} failed, ` + `${totalJobs} total ` + `(${Math.round(this.result.finished / totalJobs * 100)}% completed)`);
    }

    this.interface.clearAll();
    this.interface.log();
    /**
     * print reporter output
     */

    for (const [reporterName, messages] of Object.entries(this.messages.reporter)) {
      this.interface.log(_chalk.default.bgYellow.black(`"${reporterName}" Reporter:`));
      this.interface.log(messages.join(''));
      this.interface.log();
    }
    /**
     * print running jobs
     */


    for (const [cid, job] of Array.from(this.jobs.entries()).slice(0, MAX_RUNNING_JOBS_DISPLAY_COUNT)) {
      const filename = job.specs.join(', ').replace(process.cwd(), '');
      this.interface.log(_chalk.default.bgYellow.black(' RUNNING '), cid, 'in', job.caps.browserName, '-', filename);
    }
    /**
     * show number of pending and running jobs
     */


    if (pendingJobs || runningJobs > MAX_RUNNING_JOBS_DISPLAY_COUNT) {
      const logString = [];

      if (runningJobs > MAX_RUNNING_JOBS_DISPLAY_COUNT) {
        logString.push(runningJobs - MAX_RUNNING_JOBS_DISPLAY_COUNT, 'running tests' + (pendingJobs ? ' -' : ''));
      }

      if (pendingJobs) {
        logString.push(pendingJobs, 'pending tests');
      }

      this.interface.log(_chalk.default.yellow('...', ...logString.filter(l => Boolean(l))));
    }
    /**
     * print stdout and stderr from runners
     */


    if (isFinished) {
      /* istanbul ignore else */
      if (this.interface.stdoutBuffer.length) {
        this.interface.log(_chalk.default.bgYellow.black('Stdout:\n') + this.interface.stdoutBuffer.join(''));
      }
      /* istanbul ignore else */


      if (this.interface.stderrBuffer.length) {
        this.interface.log(_chalk.default.bgRed.black('Stderr:\n') + this.interface.stderrBuffer.join(''));
      }
      /* istanbul ignore else */


      if (this.messages.worker.error) {
        this.interface.log(_chalk.default.bgRed.black('Worker Error:\n') + this.messages.worker.error.map(e => e.stack).join('\n') + '\n');
      }
    }
    /**
     * add empty line between "pending tests" and results
     */


    if (this.jobs.size) {
      this.interface.log();
    }

    this.interface.log('Test Suites:\t', _chalk.default.green(this.result.passed, 'passed') + ', ' + (this.result.failed ? _chalk.default.red(this.result.failed, 'failed') + ', ' : '') + totalJobs, 'total', `(${totalJobs ? Math.round(this.result.finished / totalJobs * 100) : 0}% completed)`);
    this.updateClock();

    if (this.sigintTriggered) {
      clearTimeout(this.interval);
      this.interface.log('\n');
      this.interface.log(!isFinished ? 'Ending WebDriver sessions gracefully ...\n' + '(press ctrl+c again to hard kill the runner)' : 'Ended WebDriver sessions gracefully after a SIGINT signal was received!');
    }

    if (isFinished) {
      clearTimeout(this.interval);
      this.interface.log('\n');
    }
  }

  updateClock(interval = 100) {
    const clockSpinnerSymbol = this.getClockSymbol();
    clearTimeout(this.interval);
    this.interface.clearLine();
    this.interface.write('Time:\t\t ' + clockSpinnerSymbol + ' ' + ((Date.now() - this.start) / 1000).toFixed(2) + 's');
    this.interval = setTimeout(() => this.updateClock(interval), interval);
  }

  getClockSymbol() {
    return clockSpinner.frames[this.clockTimer = ++this.clockTimer % clockSpinner.frames.length];
  }

}

exports.default = WDIOCLInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnRlcmZhY2UuanMiXSwibmFtZXMiOlsibG9nIiwiY2xvY2tTcGlubmVyIiwiY2xpU3Bpbm5lcnMiLCJNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQiLCJXRElPQ0xJbnRlcmZhY2UiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInNwZWNzIiwidG90YWxXb3JrZXJDbnQiLCJoYXNBbnNpU3VwcG9ydCIsImNoYWxrIiwic3VwcG9ydHNDb2xvciIsImhhc0Jhc2ljIiwic2lnaW50VHJpZ2dlcmVkIiwiaW50ZXJmYWNlIiwiQ0xJbnRlcmZhY2UiLCJvbiIsImFkZEpvYiIsImNsZWFySm9iIiwic2V0dXAiLCJjbG9ja1RpbWVyIiwiam9icyIsIk1hcCIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsInJlc3VsdCIsImZpbmlzaGVkIiwicGFzc2VkIiwiZmFpbGVkIiwibWVzc2FnZXMiLCJyZXBvcnRlciIsIndvcmtlciIsImNsZWFyQnVmZmVyIiwiY2lkIiwiY2FwcyIsInNldCIsInVwZGF0ZVZpZXciLCJkZWxldGUiLCJvbk1lc3NhZ2UiLCJldmVudCIsIm9yaWdpbiIsIm5hbWUiLCJjbGVhclRpbWVvdXQiLCJpbnRlcnZhbCIsImNsZWFyQWxsIiwiaW5EZWJ1Z01vZGUiLCJ5ZWxsb3ciLCJwYXJhbXMiLCJpbnRyb01lc3NhZ2UiLCJ3YXJuIiwiSlNPTiIsInN0cmluZ2lmeSIsInB1c2giLCJjb250ZW50Iiwic2lnaW50VHJpZ2dlciIsIndhc0pvYkNsZWFyZWQiLCJ0b3RhbEpvYnMiLCJwZW5kaW5nSm9icyIsInNpemUiLCJydW5uaW5nSm9icyIsImlzRmluaXNoZWQiLCJjbG9ja1NwaW5uZXJTeW1ib2wiLCJnZXRDbG9ja1N5bWJvbCIsIk1hdGgiLCJyb3VuZCIsInJlcG9ydGVyTmFtZSIsIk9iamVjdCIsImVudHJpZXMiLCJiZ1llbGxvdyIsImJsYWNrIiwiam9pbiIsImpvYiIsIkFycmF5IiwiZnJvbSIsInNsaWNlIiwiZmlsZW5hbWUiLCJyZXBsYWNlIiwicHJvY2VzcyIsImN3ZCIsImJyb3dzZXJOYW1lIiwibG9nU3RyaW5nIiwiZmlsdGVyIiwibCIsIkJvb2xlYW4iLCJzdGRvdXRCdWZmZXIiLCJsZW5ndGgiLCJzdGRlcnJCdWZmZXIiLCJiZ1JlZCIsImVycm9yIiwibWFwIiwiZSIsInN0YWNrIiwiZ3JlZW4iLCJyZWQiLCJ1cGRhdGVDbG9jayIsImNsZWFyTGluZSIsIndyaXRlIiwidG9GaXhlZCIsInNldFRpbWVvdXQiLCJmcmFtZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLHFCQUFPLFVBQVAsQ0FBWjtBQUVBLE1BQU1DLFlBQVksR0FBR0MscUJBQVksT0FBWixDQUFyQjtBQUNBLE1BQU1DLDhCQUE4QixHQUFHLEVBQXZDOztBQUVlLE1BQU1DLGVBQU4sU0FBOEJDLGVBQTlCLENBQTJDO0FBQ3REQyxFQUFBQSxXQUFXLENBQUVDLE1BQUYsRUFBVUMsS0FBVixFQUFpQkMsY0FBakIsRUFBaUM7QUFDeEM7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLENBQUMsQ0FBQ0MsZUFBTUMsYUFBTixDQUFvQkMsUUFBNUM7QUFDQSxTQUFLTCxLQUFMLEdBQWFBLEtBQWI7QUFDQSxTQUFLRCxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLRSxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtLLGVBQUwsR0FBdUIsS0FBdkI7QUFFQSxTQUFLQyxTQUFMLEdBQWlCLElBQUlDLGtCQUFKLEVBQWpCO0FBQ0EsU0FBS0MsRUFBTCxDQUFRLFdBQVIsRUFBdUIsS0FBS0MsTUFBNUIsTUFBdUIsSUFBdkI7QUFDQSxTQUFLRCxFQUFMLENBQVEsU0FBUixFQUFxQixLQUFLRSxRQUExQixNQUFxQixJQUFyQjtBQUVBLFNBQUtDLEtBQUw7QUFDSDs7QUFFREEsRUFBQUEsS0FBSyxHQUFJO0FBQ0wsU0FBS0MsVUFBTCxHQUFrQixDQUFsQjtBQUNBLFNB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TCxFQUEzQjtBQUVBcEIsSUFBQUEsWUFBWSxDQUFDLEtBQUtDLFFBQU4sQ0FBWjtBQUNBLFNBQUs5QixTQUFMLENBQWVrRixTQUFmO0FBQ0EsU0FBS2xGLFNBQUwsQ0FBZW1GLEtBQWYsQ0FBcUIsZUFBZW5DLGtCQUFmLEdBQW9DLEdBQXBDLEdBQTBDLENBQUMsQ0FBQ3RDLElBQUksQ0FBQ0MsR0FBTCxLQUFhLEtBQUtGLEtBQW5CLElBQTRCLElBQTdCLEVBQW1DMkUsT0FBbkMsQ0FBMkMsQ0FBM0MsQ0FBMUMsR0FBMEYsR0FBL0c7QUFDQSxTQUFLdEQsUUFBTCxHQUFnQnVELFVBQVUsQ0FBQyxNQUFNLEtBQUtKLFdBQUwsQ0FBaUJuRCxRQUFqQixDQUFQLEVBQW1DQSxRQUFuQyxDQUExQjtBQUNIOztBQUVEbUIsRUFBQUEsY0FBYyxHQUFJO0FBQ2QsV0FBTy9ELFlBQVksQ0FBQ29HLE1BQWIsQ0FBb0IsS0FBS2hGLFVBQUwsR0FBa0IsRUFBRSxLQUFLQSxVQUFQLEdBQW9CcEIsWUFBWSxDQUFDb0csTUFBYixDQUFvQmQsTUFBOUUsQ0FBUDtBQUNIOztBQW5PcUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5pbXBvcnQgY2xpU3Bpbm5lcnMgZnJvbSAnY2xpLXNwaW5uZXJzJ1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnXG5pbXBvcnQgQ0xJbnRlcmZhY2UgZnJvbSAnQHdkaW8vaW50ZXJmYWNlJ1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAd2Rpby9sb2dnZXInXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2Rpby1jbGknKVxuXG5jb25zdCBjbG9ja1NwaW5uZXIgPSBjbGlTcGlubmVyc1snY2xvY2snXVxuY29uc3QgTUFYX1JVTk5JTkdfSk9CU19ESVNQTEFZX0NPVU5UID0gMTBcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV0RJT0NMSW50ZXJmYWNlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoY29uZmlnLCBzcGVjcywgdG90YWxXb3JrZXJDbnQpIHtcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICB0aGlzLmhhc0Fuc2lTdXBwb3J0ID0gISFjaGFsay5zdXBwb3J0c0NvbG9yLmhhc0Jhc2ljXG4gICAgICAgIHRoaXMuc3BlY3MgPSBzcGVjc1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZ1xuICAgICAgICB0aGlzLnRvdGFsV29ya2VyQ250ID0gdG90YWxXb3JrZXJDbnRcbiAgICAgICAgdGhpcy5zaWdpbnRUcmlnZ2VyZWQgPSBmYWxzZVxuXG4gICAgICAgIHRoaXMuaW50ZXJmYWNlID0gbmV3IENMSW50ZXJmYWNlKClcbiAgICAgICAgdGhpcy5vbignam9iOnN0YXJ0JywgOjp0aGlzLmFkZEpvYilcbiAgICAgICAgdGhpcy5vbignam9iOmVuZCcsIDo6dGhpcy5jbGVhckpvYilcblxuICAgICAgICB0aGlzLnNldHVwKClcbiAgICB9XG5cbiAgICBzZXR1cCAoKSB7XG4gICAgICAgIHRoaXMuY2xvY2tUaW1lciA9IDBcbiAgICAgICAgdGhpcy5qb2JzID0gbmV3IE1hcCgpXG4gICAgICAgIHRoaXMuc3RhcnQgPSBEYXRlLm5vdygpXG4gICAgICAgIHRoaXMucmVzdWx0ID0ge1xuICAgICAgICAgICAgZmluaXNoZWQ6IDAsXG4gICAgICAgICAgICBwYXNzZWQ6IDAsXG4gICAgICAgICAgICBmYWlsZWQ6IDBcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1lc3NhZ2VzID0ge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBtZXNzYWdlcyBmcm9tIHdvcmtlciByZXBvcnRlcnNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgcmVwb3J0ZXI6IHt9LFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBtZXNzYWdlcyBmcm9tIHdvcmtlciBpdHNlbGZcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgd29ya2VyOiB7fVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW50ZXJmYWNlLmNsZWFyQnVmZmVyKClcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBhZGQgam9iIHRvIGludGVyZmFjZVxuICAgICAqL1xuICAgIGFkZEpvYih7IGNpZCwgY2Fwcywgc3BlY3MgfSkge1xuICAgICAgICB0aGlzLmpvYnMuc2V0KGNpZCwgeyBjYXBzLCBzcGVjcyB9KVxuICAgICAgICB0aGlzLnVwZGF0ZVZpZXcoKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGNsZWFyIGpvYiBmcm9tIGludGVyZmFjZVxuICAgICAqL1xuICAgIGNsZWFySm9iICh7IGNpZCwgcGFzc2VkIH0pIHtcbiAgICAgICAgdGhpcy5qb2JzLmRlbGV0ZShjaWQpXG4gICAgICAgIHRoaXMucmVzdWx0LmZpbmlzaGVkKytcblxuICAgICAgICBpZiAocGFzc2VkKSB7XG4gICAgICAgICAgICB0aGlzLnJlc3VsdC5wYXNzZWQrK1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXN1bHQuZmFpbGVkKytcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudXBkYXRlVmlldyh0cnVlKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGV2ZW50IGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgd2hlbiBydW5uZXIgc2VuZHMgdXAgZXZlbnRzXG4gICAgICovXG4gICAgb25NZXNzYWdlIChldmVudCkge1xuICAgICAgICBpZiAoZXZlbnQub3JpZ2luID09PSAnZGVidWdnZXInICYmIGV2ZW50Lm5hbWUgPT09ICdzdGFydCcpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmludGVydmFsKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UuY2xlYXJBbGwoKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UuaW5EZWJ1Z01vZGUgPSB0cnVlXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coY2hhbGsueWVsbG93KGV2ZW50LnBhcmFtcy5pbnRyb01lc3NhZ2UpKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV2ZW50Lm9yaWdpbiA9PT0gJ2RlYnVnZ2VyJyAmJiBldmVudC5uYW1lID09PSAnc3RvcCcpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmluRGVidWdNb2RlID0gZmFsc2VcbiAgICAgICAgICAgIHRoaXMuc2lnaW50VHJpZ2dlcmVkID0gZmFsc2VcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVZpZXcoKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFldmVudC5vcmlnaW4gfHwgIXRoaXMubWVzc2FnZXNbZXZlbnQub3JpZ2luXSkge1xuICAgICAgICAgICAgcmV0dXJuIGxvZy53YXJuKGBDYW4ndCBpZGVudGlmeSBtZXNzYWdlIGZyb20gd29ya2VyOiAke0pTT04uc3RyaW5naWZ5KGV2ZW50KX0sIGlnbm9yaW5nIWApXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMubWVzc2FnZXNbZXZlbnQub3JpZ2luXVtldmVudC5uYW1lXSkge1xuICAgICAgICAgICAgdGhpcy5tZXNzYWdlc1tldmVudC5vcmlnaW5dW2V2ZW50Lm5hbWVdID0gW11cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1lc3NhZ2VzW2V2ZW50Lm9yaWdpbl1bZXZlbnQubmFtZV0ucHVzaChldmVudC5jb250ZW50KVxuICAgIH1cblxuICAgIHNpZ2ludFRyaWdnZXIgKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogYWxsb3cgdG8gZXhpdCByZXBsIG1vZGUgdmlhIEN0cmwrQ1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuaW50ZXJmYWNlLmluRGVidWdNb2RlKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2lnaW50VHJpZ2dlcmVkID0gdHJ1ZVxuICAgICAgICB0aGlzLnVwZGF0ZVZpZXcoKVxuICAgIH1cblxuICAgIHVwZGF0ZVZpZXcgKHdhc0pvYkNsZWFyZWQpIHtcbiAgICAgICAgY29uc3QgdG90YWxKb2JzID0gdGhpcy50b3RhbFdvcmtlckNudFxuICAgICAgICBjb25zdCBwZW5kaW5nSm9icyA9IHRoaXMudG90YWxXb3JrZXJDbnQgLSB0aGlzLmpvYnMuc2l6ZSAtIHRoaXMucmVzdWx0LmZpbmlzaGVkXG4gICAgICAgIGNvbnN0IHJ1bm5pbmdKb2JzID0gdGhpcy5qb2JzLnNpemVcbiAgICAgICAgY29uc3QgaXNGaW5pc2hlZCA9IHJ1bm5pbmdKb2JzID09PSAwXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGNoZWNrIGlmIGVudmlyb25tZW50IHN1cHBvcnRzIGFuc2kgYW5kIHByaW50IGEgbGltaXRlZCB1cGRhdGUgaWYgbm90XG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIXRoaXMuaGFzQW5zaVN1cHBvcnQgJiYgIWlzRmluaXNoZWQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogb25seSB1cGRhdGUgaWYgYSBqb2IgZmluaXNoZXNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKCF3YXNKb2JDbGVhcmVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGNsb2NrU3Bpbm5lclN5bWJvbCA9IHRoaXMuZ2V0Q2xvY2tTeW1ib2woKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJmYWNlLmxvZyhcbiAgICAgICAgICAgICAgICBgJHtjbG9ja1NwaW5uZXJTeW1ib2x9IGAgK1xuICAgICAgICAgICAgICAgIGAke3RoaXMuam9icy5zaXplfSBydW5uaW5nLCBgICtcbiAgICAgICAgICAgICAgICBgJHt0aGlzLnJlc3VsdC5wYXNzZWR9IHBhc3NlZCwgYCArXG4gICAgICAgICAgICAgICAgYCR7dGhpcy5yZXN1bHQuZmFpbGVkfSBmYWlsZWQsIGAgK1xuICAgICAgICAgICAgICAgIGAke3RvdGFsSm9ic30gdG90YWwgYCArXG4gICAgICAgICAgICAgICAgYCgke01hdGgucm91bmQoKHRoaXMucmVzdWx0LmZpbmlzaGVkIC8gdG90YWxKb2JzKSAqIDEwMCl9JSBjb21wbGV0ZWQpYClcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW50ZXJmYWNlLmNsZWFyQWxsKClcbiAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKClcblxuICAgICAgICAvKipcbiAgICAgICAgICogcHJpbnQgcmVwb3J0ZXIgb3V0cHV0XG4gICAgICAgICAqL1xuICAgICAgICBmb3IgKGNvbnN0IFtyZXBvcnRlck5hbWUsIG1lc3NhZ2VzXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLm1lc3NhZ2VzLnJlcG9ydGVyKSkge1xuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKGNoYWxrLmJnWWVsbG93LmJsYWNrKGBcIiR7cmVwb3J0ZXJOYW1lfVwiIFJlcG9ydGVyOmApKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKG1lc3NhZ2VzLmpvaW4oJycpKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKClcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBwcmludCBydW5uaW5nIGpvYnNcbiAgICAgICAgICovXG4gICAgICAgIGZvciAoY29uc3QgW2NpZCwgam9iXSBvZiBBcnJheS5mcm9tKHRoaXMuam9icy5lbnRyaWVzKCkpLnNsaWNlKDAsIE1BWF9SVU5OSU5HX0pPQlNfRElTUExBWV9DT1VOVCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gam9iLnNwZWNzLmpvaW4oJywgJykucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJylcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhjaGFsay5iZ1llbGxvdy5ibGFjaygnIFJVTk5JTkcgJyksIGNpZCwgJ2luJywgam9iLmNhcHMuYnJvd3Nlck5hbWUsICctJywgZmlsZW5hbWUpXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogc2hvdyBudW1iZXIgb2YgcGVuZGluZyBhbmQgcnVubmluZyBqb2JzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAocGVuZGluZ0pvYnMgfHwgcnVubmluZ0pvYnMgPiBNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQpIHtcbiAgICAgICAgICAgIGNvbnN0IGxvZ1N0cmluZyA9IFtdXG4gICAgICAgICAgICBpZiAocnVubmluZ0pvYnMgPiBNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQpIHtcbiAgICAgICAgICAgICAgICBsb2dTdHJpbmcucHVzaChcbiAgICAgICAgICAgICAgICAgICAgcnVubmluZ0pvYnMgLSBNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgICdydW5uaW5nIHRlc3RzJyArIChwZW5kaW5nSm9icyA/ICcgLScgOiAnJykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGVuZGluZ0pvYnMpIHtcbiAgICAgICAgICAgICAgICBsb2dTdHJpbmcucHVzaChwZW5kaW5nSm9icywgJ3BlbmRpbmcgdGVzdHMnKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKGNoYWxrLnllbGxvdygnLi4uJywgLi4ubG9nU3RyaW5nLmZpbHRlcihsID0+IEJvb2xlYW4obCkpKSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBwcmludCBzdGRvdXQgYW5kIHN0ZGVyciBmcm9tIHJ1bm5lcnNcbiAgICAgICAgICovXG4gICAgICAgIGlmIChpc0ZpbmlzaGVkKSB7XG4gICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgICAgICAgaWYgKHRoaXMuaW50ZXJmYWNlLnN0ZG91dEJ1ZmZlci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coY2hhbGsuYmdZZWxsb3cuYmxhY2soJ1N0ZG91dDpcXG4nKSArIHRoaXMuaW50ZXJmYWNlLnN0ZG91dEJ1ZmZlci5qb2luKCcnKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG4gICAgICAgICAgICBpZiAodGhpcy5pbnRlcmZhY2Uuc3RkZXJyQnVmZmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhjaGFsay5iZ1JlZC5ibGFjaygnU3RkZXJyOlxcbicpICsgdGhpcy5pbnRlcmZhY2Uuc3RkZXJyQnVmZmVyLmpvaW4oJycpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgICAgIGlmICh0aGlzLm1lc3NhZ2VzLndvcmtlci5lcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhjaGFsay5iZ1JlZC5ibGFjaygnV29ya2VyIEVycm9yOlxcbicpICsgdGhpcy5tZXNzYWdlcy53b3JrZXIuZXJyb3IubWFwKFxuICAgICAgICAgICAgICAgICAgICAoZSkgPT4gZS5zdGFja1xuICAgICAgICAgICAgICAgICkuam9pbignXFxuJykgKyAnXFxuJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBhZGQgZW1wdHkgbGluZSBiZXR3ZWVuIFwicGVuZGluZyB0ZXN0c1wiIGFuZCByZXN1bHRzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5qb2JzLnNpemUpIHtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZygpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coXG4gICAgICAgICAgICAnVGVzdCBTdWl0ZXM6XFx0JywgY2hhbGsuZ3JlZW4odGhpcy5yZXN1bHQucGFzc2VkLCAncGFzc2VkJykgKyAnLCAnICtcbiAgICAgICAgICAgICh0aGlzLnJlc3VsdC5mYWlsZWQgPyBjaGFsay5yZWQodGhpcy5yZXN1bHQuZmFpbGVkLCAnZmFpbGVkJykgKyAnLCAnIDogJycpICtcbiAgICAgICAgICAgIHRvdGFsSm9icywgJ3RvdGFsJyxcbiAgICAgICAgICAgIGAoJHt0b3RhbEpvYnMgPyBNYXRoLnJvdW5kKCh0aGlzLnJlc3VsdC5maW5pc2hlZCAvIHRvdGFsSm9icykgKiAxMDApIDogMH0lIGNvbXBsZXRlZClgXG4gICAgICAgIClcblxuICAgICAgICB0aGlzLnVwZGF0ZUNsb2NrKClcblxuICAgICAgICBpZiAodGhpcy5zaWdpbnRUcmlnZ2VyZWQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmludGVydmFsKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKCdcXG4nKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKCFpc0ZpbmlzaGVkXG4gICAgICAgICAgICAgICAgPyAnRW5kaW5nIFdlYkRyaXZlciBzZXNzaW9ucyBncmFjZWZ1bGx5IC4uLlxcbicgK1xuICAgICAgICAgICAgICAgICAgJyhwcmVzcyBjdHJsK2MgYWdhaW4gdG8gaGFyZCBraWxsIHRoZSBydW5uZXIpJ1xuICAgICAgICAgICAgICAgIDogJ0VuZGVkIFdlYkRyaXZlciBzZXNzaW9ucyBncmFjZWZ1bGx5IGFmdGVyIGEgU0lHSU5UIHNpZ25hbCB3YXMgcmVjZWl2ZWQhJ1xuICAgICAgICAgICAgKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzRmluaXNoZWQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmludGVydmFsKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKCdcXG4nKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlQ2xvY2sgKGludGVydmFsID0gMTAwKSB7XG4gICAgICAgIGNvbnN0IGNsb2NrU3Bpbm5lclN5bWJvbCA9IHRoaXMuZ2V0Q2xvY2tTeW1ib2woKVxuXG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmludGVydmFsKVxuICAgICAgICB0aGlzLmludGVyZmFjZS5jbGVhckxpbmUoKVxuICAgICAgICB0aGlzLmludGVyZmFjZS53cml0ZSgnVGltZTpcXHRcXHQgJyArIGNsb2NrU3Bpbm5lclN5bWJvbCArICcgJyArICgoRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnQpIC8gMTAwMCkudG9GaXhlZCgyKSArICdzJylcbiAgICAgICAgdGhpcy5pbnRlcnZhbCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVDbG9jayhpbnRlcnZhbCksIGludGVydmFsKVxuICAgIH1cblxuICAgIGdldENsb2NrU3ltYm9sICgpIHtcbiAgICAgICAgcmV0dXJuIGNsb2NrU3Bpbm5lci5mcmFtZXNbdGhpcy5jbG9ja1RpbWVyID0gKyt0aGlzLmNsb2NrVGltZXIgJSBjbG9ja1NwaW5uZXIuZnJhbWVzLmxlbmd0aF1cbiAgICB9XG59XG4iXX0=